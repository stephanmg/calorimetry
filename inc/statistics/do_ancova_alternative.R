library(tidyverse)
library(ggpubr)
library(rstatix)
library(broom)
library(emmeans)

################################################################################
#' brunner_munzel
#' 
#' This function get's the p-value for the Brunner Munzel test (statistic)
#' @param df
brunner_munzel <- function(df) {
  return(lawsat::brunner.munzel.test(as.numeric(df$TEE) ~ data$group)$p.value)
}

################################################################################
#' get_r_squared_clean
#' 
#' This function get's the R-squared value in a clean way for plotly
#' @param rvalue
################################################################################
get_r_squared_clean <- function(rvalue) {
  r_squared_value <- sub(".*italic\\(R\\)\\^2\\s=\\s(-?[0-9.]+).*", "\\1", rvalue)
  return(as.numeric(r_squared_value))
}

################################################################################
#' calculate_statistic
#' 
#' This function calculate statistic based on provided method: mean or median
#' @param data
#' @param method
################################################################################
calculate_statistic <- function(data, method) {
  switch(method,
    mean = mean(data),
    median = median(data),
    mean(data))
}

################################################################################
#' do_ancova_alternative
#' 
#' This function performs multi-way ANCOVA or ANOVA analysis
#' @param df_data
#' @param df_metadata
#' @param indep_var
#' @param indep_var2
#' @param group
#' @param group2
#' @param dep_var
#' @param test_type
#' @param adjust_method
#' @param connected_or_independent_anova
#' @param num_covariates
#' @param repeated_measurements
#' @param lm_or_glm
################################################################################
# TODO: Add possibility to let the user choose the glm family and link function 
# via the inputs (input$glm_family and input$link_function) - not only defaults
do_ancova_alternative <- function(df_data, df_metadata, indep_var, indep_var2, group, group2, dep_var, test_type, adjust_method = "bonferroni", connected_or_independent_ancova=FALSE, num_covariates=1, repeated_measurements=FALSE, lm_or_glm=FALSE) {
  print("dataframe:")
  print(df_data)
  df <- df_data %>% full_join(y = df_metadata, by = c("Animals")) %>% na.omit() 
  # Might not be necessary, does no harm, can be removed if no adverse effects revealed during testing
  if (! "Genotype" %in% names(df)) {
    if ("Genotype.x" %in% names(df)) {
      df <- df %>% rename(Genotype = `Genotype.x`)
    }
  }

  if (is.null(indep_var)) {
    indep_var <- "body_weight"
  }

  # TODO: Rename covariates for ANCOVA
  # First covariate, rename Weight -> Covariate1
  # Second covariate, rename Weight2 -> Covariate2
  names(df)[names(df) == indep_var] <- "Weight"

  # ANCOVA which uses multiple covariate
  if (num_covariates > 1) {
    if (is.null(indep_var2)) {
      indep_var2 <- "lean_mass"
    }
    names(df)[names(df) == indep_var2] <- "Weight2"
  }

  # first grouping variable, set some sensible default, Genotype should always be available
  if (is.null(group)) {
    group <- "Genotype"
  }

  # second grouping variable, set some sensible default, Days should always be available
  if (is.null(group2)) {
    group2 <- "Days"
  }

  names(df)[names(df) == group] <- "group"

  if (dep_var == "HP") {
    df <- df %>% select(-Days)
    # TODO: for DayNight activity, 2nd grouping variable Genotype or Diet renamed to Days, needs to be changed to a generic name, e.g. group2
    names(df)[names(df) == group2] <- "Days"
  }

  to_select_columns = c("Animals", "group", "Weight", "TEE", "Days")
  if (num_covariates > 1) {
    to_select_columns = c("Animals", "group", "Weight", "Weight2", "TEE", "Days")
  }

  # TODO: Rename TEE for ANCOVA 
  # -> DependentVariable to generalize/cleanup the naming of variables in this statistics module
  if (dep_var == "TEE") {
    df <- df %>% select(all_of(to_select_columns))
  } else if (dep_var == "GoxLox") {
    names(df)[names(df) == dep_var] <- "TEE"
    df <- df %>% select(all_of(to_select_columns))
  } else if (dep_var == "HP") {
    names(df)[names(df) == dep_var] <- "TEE"
    df <- df %>% select(all_of(to_select_columns))
  } else if (dep_var == "Raw") {
    names(df)[names(df) == dep_var] <- "TEE"
    df <- df %>% select(all_of(to_select_columns))
  } else if (dep_var == "RMR") { 
    names(df)[names(df) == dep_var] <- "TEE" 
    if (num_covariates > 1) {
      df <- df %>% select(c("Animals", "group", "Weight", "Weight2", "TEE", "Days"))
    } else {
      df <- df %>% select(c("Animals", "group", "Weight", "TEE", "Days"))
    }
  } else if (dep_var == "EE") {
    names(df)[names(df) == dep_var] <- "TEE"
    if (num_covariates > 1) {
      df <- df %>% select(c("Animals", "group", "Weight", "Weight2", "TEE", "Days"))
    } else {
      df <- df %>% select(c("Animals", "group", "Weight", "TEE", "Days"))
    }
  } else { # other quantities are supported only by 1-way ANCOVA with either 1 or 2 covariates
    if (num_covariates > 1) {
      df <- df %>% select(c("Animals", "group", "Weight", "Weight2", "TEE"))
    } else {
      df <- df %>% select(c("Animals", "group", "Weight", "TEE"))
    }
  }

  # covariates need to be always numeric, tse header must be prepared better, see util methods to allow only numerical non-factor columns?
  df$Weight <- as.numeric(df$Weight)
  if (num_covariates > 1) {
    df$Weight2 <- as.numeric(df$Weight2)
  }
  df$TEE <- as.numeric(df$TEE)

  if (test_type == "1-way ANCOVA") {
    if (dep_var == "TEE") {
      df = df %>% group_by(Animals) %>% summarize(TEE=mean(TEE, na.rm=TRUE), across(-TEE, first))
    } else if (dep_var == "GoxLox") {
      df = df %>% group_by(Animals) %>% summarize(TEE=mean(TEE, na.rm=TRUE), across(-TEE, first))
    } else if (dep_var == "HP") {
      df = df %>% group_by(group, Animals) %>% summarize(TEE=mean(TEE, na.rm=TRUE), across(-TEE, first)) %>% ungroup()
    } else if (dep_var == "Raw") {
      df = df %>% group_by(Animals) %>% summarize(TEE=mean(TEE, na.rm=TRUE), across(-TEE, first))
    } else if (dep_var == "RMR") {
      df = df %>% group_by(Animals)  %>% summarize(TEE=mean(TEE, na.rm=TRUE), across(-TEE, first))
    } else if (dep_var == "EE") {
      df = df %>% group_by(group, Animals) %>% summarize(TEE=mean(TEE, na.rm=TRUE), across(-TEE, first)) %>% ungroup()
    }
  } 

  if (test_type == "2-way ANCOVA" || test_type == "2-way ANOVA") {
    if (dep_var == "HP" || dep_var == "EE" || dep_var == "RMR") {
      if (num_covariates > 1) {
        df = as.data.frame(df) %>% select(c("Animals", "group", "Weight", "Weight2", "TEE", "Days")) %>% distinct()
      } else {
        df = as.data.frame(df) %>% select(c("Animals", "group", "Weight", "TEE", "Days")) %>% distinct()
      }
    }
  }

  p2 <- NULL
  p3 <- NULL
  if (dep_var == "TEE") {
    p2 <- ggscatter(df, x = "Weight", y = "TEE", color = "group", add = "reg.line", alpha=0) 
    p2 <- p2 + stat_regline_equation(aes(label = after_stat(rr.label), color = group), label.y=c(max(df$TEE), max(df$TEE)), label.x=c(min(df$Weight), min(df$Weight)+1), geom="text", output.type = "text", parse=FALSE)
    p2 <- p2 + geom_point(aes(text=paste0("ID: ", Animals, "<br>Day: ", Days), color=group), label = "", alpha=1)

    if (num_covariates > 1) {
     p3 <- ggscatter(df, x = "Weight2", y = "TEE", color = "group", add = "reg.line")
     p3 <- p3 + stat_regline_equation(aes(label = after_stat(rr.label), color = group), label.y=c(max(df$TEE), max(df$TEE)), label.x=c(min(df$Weight2), min(df$Weight2)+1), geom="text", output.type = "text", parse=FALSE)
     p3 <- p3 + geom_point(aes(text=paste0("ID: ", Animals, "<br>Day: ", Days), color=group), label = "", alpha=1)
    }

  } else {
    group_count <- length(unique(df$group))
    y_max <- max(df$TEE)
    y_range <- max(df$TEE) - min(df$TEE)
    label_x <- rep(min(df$Weight), group_count)
    label_y <- seq(y_max, y_max+((y_range * 0.05) * (group_count - 1)), length.out = group_count)
    df <- df %>% rename(!!dep_var := TEE)
    p2 <- ggscatter(df, x = "Weight", y = dep_var, color = "group", add = "reg.line", alpha=0)
    p2 <- p2 + stat_regline_equation(aes(label = after_stat(rr.label), color = group), label.y=label_y, label.x=label_x, geom="text", output.type = "text", parse=FALSE)
    if (dep_var == "RMR" || dep_var == "EE") {
      # TODO: RMR and EE comes already averaged per Days
      p2 <- p2 + geom_point(aes(text=paste0("ID: ", Animals), color=group), label = "", alpha=1)
    } else {
      p2 <- p2 + geom_point(aes(text=paste0("ID: ", Animals, "<br>Day: ", Days), color=group), label = "", alpha=1)
    }
    df <- df %>% rename(TEE := !!dep_var)
    if (num_covariates > 1) {
      df <- df %>% rename(!!dep_var := TEE)
      p3 <- ggscatter(df, x = "Weight2", y = dep_var, color = "group", add = "reg.line")
      p3 <- p3 + stat_regline_equation(aes(label = after_stat(rr.label), color = group), label.y=c(max(df$TEE), max(df$TEE)), label.x=c(min(df$Weight2), min(df$Weight2)+1.0), geom="text", output.type = "text", parse=FALSE)
     if (dep_var == "RMR" || dep_var == "EE") {
        # TODO: RMR and EE comes already averaged per Days
      p3 <- p3 + geom_point(aes(text=paste0("ID: ", Animals), color=group), label = "", alpha=1)
     } else {
      p3 <- p3 + geom_point(aes(text=paste0("ID: ", Animals, "<br>Day: ", Days), color=group), label = "", alpha=1)
     }
      df <- df %>% rename(TEE := !!dep_var)
    }
  }

  p2 <- p2 + labs(colour=group)
  if (num_covariates > 1) {
    p3 <- p3 + labs(colour=group)
  }

  # 1-way ANCOVA based on user input grouping variable
  res.aov <- NULL
  if (test_type == "1-way ANCOVA") {
    if (num_covariates > 1) {
      res.aov <- df %>% anova_test(TEE ~ Weight * Weight2 + group)
    } else {
      res.aov <- df %>% anova_test(TEE ~ Weight + group)
    }
  }

  if (test_type == "2-way ANCOVA") {
    # 2-way ANCOVA for now uses Days as second group always
    if (connected_or_independent_ancova) { # interaction, group and Days are independent categorial grouping variables
        if (num_covariates > 1) {
          res.aov <- df %>% anova_test(TEE ~ Weight + Weight2 + group * Days)
        } else {
          res.aov <- df %>% anova_test(TEE ~ Weight + group * Days)
        }
    } else { # otherwise assume that there is no interaction
      if (num_covariates > 1) {
        res.aov <- df %>% anova_test(TEE ~ Weight:Weight2:group:Days)
      } else {
        res.aov <- df %>% anova_test(TEE ~ Weight:group:Days)
      }
    }
  }

  p <- NULL
  pwc <- NULL
  if (test_type == "1-way ANCOVA") {
    pwc <- df %>%
      emmeans_test(
        TEE ~ group, covariate = Weight,
        p.adjust.method = adjust_method
      )

  mean_p_value = mean(pwc$p.adj)
  # Visualization of estimated marginal means for 1-way ancova
  pwc <- pwc %>% add_xy_position(x = "group", fun = "mean_se")
  p <- ggline(get_emmeans(pwc), x = "group", y = "emmean", color="group", group="group") +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high, color=group), width = 0.1) 
    p <- p + annotate("text", x  = 1.0, y = max(get_emmeans(pwc)$emmean) + 1, label = paste0("p-value: ", round(mean_p_value, 6)), size = 4)

  }

  if (test_type == "2-way ANCOVA") {
    df$Days = as.factor(df$Days)
    pwc <- df %>% group_by(group) %>% emmeans_test(TEE ~ Days, covariate=Weight)
    pwc <- pwc %>% add_xy_position(x = "group", fun = "mean_se")
    p <- ggline(get_emmeans(pwc), x = "group", y="emmean", color="Days") 
    p <- p + geom_errorbar(aes(ymin=conf.low, ymax=conf.high, color=Days), width=0.1)
    p <- p + stat_pvalue_manual(pwc, hide.ns = TRUE, tip.length = FALSE) +
    labs(
      subtitle = get_test_label(res.aov, detailed = TRUE),
      caption = get_pwc_label(pwc)
    )
  }

  # Fit the model, the covariate goes first
  model <- lm(TEE ~ Weight + group, data = df)

  ##############################################################################
  ### TODO: Code below is obsolete
  # TODO: adjust to use both covariates if using ANCOVA,
  # and then also both covariates for repeated measurement anova
  if (test_type == "2-way ANCOVA") {
     model <- lm(TEE ~ Weight + group * Days, data = df)
  }

  if (test_type == "2-way ANOVA") {
    if (repeated_measurements) {
    } else {
      model <- lm(TEE ~ group * Days, data = df)
    }
  }
  ### TODO: Code above is obsolete
  ##############################################################################

  # Check test assumptions met in general
  model.metrics <- augment(model)
  shapiro <- shapiro_test(model.metrics$.resid[0:5000]) # FIXME: shapiro can only handle 5000 samples max
  levene <- model.metrics %>% levene_test(.resid ~ group)

  if (test_type == "2-way ANOVA" || test_type == "2-way ANCOVA") {
      df$Days <- as.factor(df$Days)
      model = lm(TEE ~ group * Days, data=df)
      if (lm_or_glm == TRUE) {
        model = glm(TEE ~ group * Days, data=df)
      }

      if (repeated_measurements) {
        model = nlme::lme(TEE ~ group * Days, random=~1|Animals, data=df)
      }

      if (test_type == "2-way ANCOVA") {
        model = lm(TEE ~ group * Days + Weight, data=df)
        if (lm_or_glm == TRUE) {
          model = glm(TEE ~ group * Days + Weight, data=df)
        }
        if (repeated_measurements) {
          model = nlme::lme(TEE ~ group * Days + Weight, random=~1|Animals, data=df)
        }
        if (num_covariates > 1) {
          model = lm(TEE ~ group * Days + Weight + Weight2, data=df)
          if (lm_or_glm == TRUE) {
            model = glm(TEE ~ group * Days + Weight + Weight2, data=df)
          }

          if (repeated_measurements) {
            model = nlme::lme(TEE ~ group * Days + Weight + Weight2, random=~1|Animals, data=df)
          }
        }
      } 

      emm = emmeans(model, ~Days | group)
      emm_df <- as.data.frame(emm)
      p <- ggplot(emm_df, aes(x=Days, y=emmean, group=group, color=group)) + geom_line() + geom_point()
      p <- p + geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE), width=0.2) 

      # TODO: add selection of first or second grouping variable
      # if (input$first_or_second_factor_for_2_way_analysis) {
      # by="group" and rename(group2=group) instead of
      # by="Days" and rename(group2=Days) below
      # }
      pairwise_raw <- contrast(emm, method="pairwise", by="Days") %>% as.data.frame()
      pairwise <- contrast(emm, method="pairwise", by="Days", adjust="tukey") %>% as.data.frame() %>% mutate(
        significance=case_when(
          p.value < 0.001 ~ "***",
          p.value < 0.01 ~ "**",
          p.value < 0.05 ~ "*",
          TRUE ~ "ns"
        )
      ) %>% rename(group1=contrast) %>% rename(group2=Days) %>% rename(statistic=t.ratio) %>% rename(p=p.value) %>% rename(p.adj.signif=significance)
      pairwise <- pairwise %>% mutate(p.adj = pairwise_raw$p.value)
      mean_p_value <- mean(pairwise$p.adj)
      p <- p + annotate("text", x = levels(emm_df$Days)[1], y = min(emm_df$emmean) -1, label=paste0("p-value: ", round(mean_p_value, 6)))
      pwc <- pairwise 
  } 

  # for ANOVAs report statistics directly in panel Statistical Testing, no Details section required.
  if (test_type == "1-way ANOVA") {
    # FIXME: plotly does not support comparisons=pairs in stat_compare_means()
    #df$group <- as.character(df$group)
    #pairs <- combn(unique(df$group), 2, simplify=FALSE)
    p2 <- ggplot(df, aes(x = group, y = TEE, color = group)) + geom_boxplot(outlier.shape=15, outlier.size=0, outlier.color="red") # outlier.shape=NA)  
    #if (dep_var == "RMR" || dep_var == "EE") {
    #  p2 <- p2 + geom_jitter(aes(text=paste0("ID: ", Animals, "<br>", "Group: ", group)), size=3, width=0.2, alpha=0.6)
    #  p2 <- p2 + stat_compare_means()
    #} else {
      p2 <- p2 + geom_jitter(aes(text=paste0("ID: ", Animals, "<br>", "Group: ", group, "<br>Day: ", Days)), size=3, width=0.2, alpha=0.6)
      p2 <- p2 + stat_compare_means()
    #}
  }

  if (test_type == "2-way ANOVA") {
    df$Days <- as.factor(df$Days)
    if (connected_or_independent_ancova) {
       p2 <- ggboxplot(df, "group", "TEE", color = "Days")
       p2 <- p2 + geom_jitter(aes(text=paste0("ID: ", Animals, "<br>", "Group: ", group, "<br>Day: ", Days), color=Days), size=3, width=0.2, alpha=0.6)
       p2_old <- p2
       result <- try({
        p2 <<- p2 + stat_compare_means(
        aes(group = Days), method="anova", label="p.format")
       }, silent=TRUE)
       if (inherits(result, "try-error")) {
        p2 <<- p2_old + stat_compare_means()
       } 
    } else {
       p2 <- ggboxplot(df, "group", "TEE", color = "Days")
       p2 <- p2 + geom_jitter(aes(text=paste0("ID: ", Animals, "<br>", "Group: ", group, "<br>Day: ", Days), color=Days), size=3, width=0.2, alpha=0.6)
       p2 <- p2 + stat_compare_means()
    }
  }

  if (test_type == '1-way ANOVA' || test_type == '1-way GLM') {
    model = lm(TEE ~ group, data=df)
    if (lm_or_glm == TRUE) { # use GLM
      model = glm(TEE ~ group, data=df)
    }
    emm = emmeans(model, ~ group)
    emm_df <- as.data.frame(emm)

     pairwise_raw <- contrast(emm, method="pairwise") %>% as.data.frame()
      pairwise <- contrast(emm, method="pairwise", adjust="tukey") %>% as.data.frame() %>% mutate(
        significance=case_when(
          p.value < 0.001 ~ "***",
          p.value < 0.01 ~ "**",
          p.value < 0.05 ~ "*",
          TRUE ~ "ns"
        )
      ) 
      pairwise <- pairwise %>% rename(group1=contrast) %>% rename(statistic=t.ratio) %>% rename(p=p.value) %>% rename(p.adj.signif=significance)
      pairwise <- pairwise %>% mutate(p.adj = pairwise_raw$p.value)
      pairwise$group2 <- length(unique(df$Days))
      mean_p_value <- mean(pairwise$p.adj)

      p <- ggplot(emm_df, aes(x=group, y=emmean, group=group, color=group)) + geom_line() + geom_point()
      p <- p + geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE), width=0.1) 
      p <- p + annotate("text", x  = 1.0, y = max(emm_df$emmean) + 1, label = paste0("p-value: ", round(mean_p_value, 6)), size = 4)
      pwc <- pairwise 
  }

  regression_slopes <- summary(aov(TEE ~ Weight:group, data = df))
  regression_slopes <- regression_slopes[[1]]["Weight:group", "Pr(>F)"]

  return(list(
    "plot_details" = p, # Details plot
    "plot_summary" = p2, # first covariate in Statistical Testing panel
    "plot_summary2" = p3,  # second covariate Statistical Testing panel
    "statistics" = pwc, # Statistics table below Details plot
    "shapiro" = shapiro, # ...
    "levene" = levene, # ...
    "regression_slopes" = regression_slopes, ### Statistics table below Details plot
    "df"=df))
}
